<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>My Trades - RationalMarkets</title>
    <meta name="description" content="Create and manage your investment trade ideas with AI assistance">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        .header {
            text-align: center;
            margin-bottom: 3rem;
            color: white;
        }
        .header h1 {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 1rem;
        }
        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px 15px 0 0 !important;
            padding: 1.5rem;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 10px;
            padding: 1rem 2rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .form-control, .form-select {
            border-radius: 10px;
            border: 2px solid #e9ecef;
            padding: 1rem;
            transition: all 0.3s ease;
        }
        .form-control:focus, .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        .position-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }
        .position-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .long-position {
            border-left: 4px solid #28a745;
        }
        .short-position {
            border-left: 4px solid #dc3545;
        }
        .return-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);  /* 4 columns side by side */
            gap: 0.5rem;
            margin-bottom: 2rem;
        }
        @media (max-width: 576px) {
            .return-grid {
                gap: 0.4rem;  /* Smaller gap on mobile */
            }
        }
        .return-card {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 1rem;  /* Reduced from 1.5rem */
            border-radius: 10px;
            text-align: center;
        }
        .return-card h3 {
            font-size: 1.5rem;  /* Reduced from 2rem */
            font-weight: bold;
            margin-bottom: 0.3rem;
        }
        @media (max-width: 576px) {
            .return-card {
                padding: 0.6rem 0.4rem;  /* Smaller padding on mobile */
            }
            .return-card h3 {
                font-size: 1.2rem;  /* Smaller font on mobile */
            }
        }
        .badge {
            font-size: 0.9rem;
            padding: 0.5rem 1rem;
            border-radius: 20px;
        }
        .loading {
            text-align: center;
            padding: 3rem;
        }
        .spinner {
            width: 3rem;
            height: 3rem;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .back-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255,255,255,0.9);
            color: #667eea;
            border: none;
            border-radius: 50px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.3s ease;
            z-index: 1000;
        }
        .back-btn:hover {
            background: white;
            color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
    </style>
    <script src="auth-check.js"></script>
    <!-- TradingView Widget Library -->
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
</head>
<body data-require-auth="true">
    <a href="index.html" class="btn btn-outline-light position-absolute" style="top: 20px; left: 20px; z-index: 1000;">
        <i class="fas fa-arrow-left"></i><span class="d-none d-md-inline ms-2">Back to Home</span>
    </a>

    <div class="main-container">
        <div class="header">
            <h1><i class="fas fa-briefcase me-3"></i>My Trades</h1>
            <p>Describe your investment idea and let our AI analyze and implement it with specific stock recommendations</p>
        </div>

        <!-- Trade Input Form -->
        <!-- AI Description -->
        <div class="card mb-4">
            <div class="card-body" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border-radius: 15px;">
                <h5><i class="fas fa-robot me-2"></i>AI-Powered Trade Analysis</h5>
                <p class="mb-0">Our AI analyzes your trade ideas and provides detailed recommendations including specific stock positions, allocations, risk assessment, and return estimates with rationale. Simply describe your investment thesis, and let our AI do the rest.</p>
            </div>
        </div>

        <div id="inputForm" class="card">
            <div class="card-header">
                <h3 class="mb-0"><i class="fas fa-lightbulb me-2"></i>Suggest a Trade Idea</h3>
            </div>
            <div class="card-body">
                <div class="mb-4">
                    <label for="tradeName" class="form-label fw-bold">Trade Name</label>
                    <input type="text" class="form-control" id="tradeName" placeholder="e.g., AI Bubble Short Strategy">
                </div>
                <div class="mb-4">
                    <label for="tradeDescription" class="form-label fw-bold">Trade Idea Description</label>
                    <textarea class="form-control" id="tradeDescription" rows="4" placeholder="Describe your investment thesis... e.g., 'I believe AI stocks are in a bubble and want to short the most overvalued ones like NVIDIA and Tesla.'"></textarea>
                </div>
                <div class="mb-4">
                    <div class="alert alert-info" role="alert">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Note:</strong> Currently supporting <strong>US stocks only</strong>. ETFs, indices, and international stocks coming soon.
                    </div>
                </div>
                <div class="mb-4">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="includeDerivatives" value="">
                        <label class="form-check-label" for="includeDerivatives">
                            <strong>Include Derivatives</strong> <span class="text-muted">(options, futures)</span>
                        </label>
                    </div>
                </div>
                <button class="btn btn-primary btn-lg w-100" onclick="analyzeTradeWithAI()">
                    <i class="fas fa-brain me-2"></i>Generate Trade Recommendation
                </button>
            </div>
        </div>


        <!-- Loading State -->
        <div id="loadingState" class="card" style="display: none;">
            <div class="card-body loading">
                <div class="spinner"></div>
                <h4>AI is analyzing your trade idea...</h4>
                <p class="text-muted">This may take a few seconds</p>
            </div>
        </div>

        <!-- Analysis Results -->
        <div id="analysisResults" style="display: none;">
            <!-- Trade Header -->
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h2 id="resultTradeName" class="mb-2"></h2>
                            <p class="text-muted mb-0">Created by <span id="resultOwner"></span> â€¢ <span id="resultDate"></span></p>
                        </div>
                        <div>
                            <span id="resultRecommendation" class="badge bg-success me-2"></span>
                            <span id="resultRisk" class="badge bg-warning"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Trade Statistics & Analysis Section (COMPREHENSIVE) -->
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Trade Statistics & Analysis</h4>
                </div>
                <div class="card-body">
                    <!-- AI Rationale (FIRST - Most Important) -->
                    <div class="mb-4 p-3" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; color: white;">
                        <h5 class="mb-3"><i class="fas fa-brain me-2"></i>AI Analysis & Rationale</h5>
                        <p id="aiRationale" class="mb-0" style="font-size: 1.05rem; line-height: 1.6;"></p>
                    </div>

                    <!-- Portfolio Metrics Container (will be populated by JS) -->
                    <div id="portfolioMetricsContainer" class="mb-4"></div>

                    <!-- Return Estimates with Rationales -->
                    <div class="mb-4">
                        <h5 class="mb-3"><i class="fas fa-chart-line me-2"></i>Expected Returns</h5>
                        <div id="returnGrid" class="return-grid mb-3"></div>
                        <div id="returnRationale" class="mt-3" style="padding: 1.5rem; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 10px;">
                            <h6 class="mb-3"><i class="fas fa-info-circle me-2"></i>Return Estimate Rationales</h6>
                            <div id="returnRationaleText" class="mb-0"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Positions Section -->
            <!-- Long Positions -->
            <div id="longPositionsCard" class="card" style="display: none;">
                <div class="card-header">
                    <h4 class="mb-0"><i class="fas fa-arrow-up me-2 text-success"></i>Long Positions</h4>
                </div>
                <div class="card-body">
                    <div id="longPositions"></div>
                </div>
            </div>

            <!-- Short Positions -->
            <div id="shortPositionsCard" class="card" style="display: none;">
                <div class="card-header">
                    <h4 class="mb-0"><i class="fas fa-arrow-down me-2 text-danger"></i>Short Positions</h4>
                </div>
                <div class="card-body">
                    <div id="shortPositions"></div>
                </div>
            </div>

            <!-- Derivatives -->
            <div id="derivativesCard" class="card" style="display: none;">
                <div class="card-header">
                    <h4 class="mb-0"><i class="fas fa-chart-line me-2 text-warning"></i>Derivatives</h4>
                </div>
                <div class="card-body">
                    <div id="derivativePositions"></div>
                </div>
            </div>

                        <!-- Action Buttons -->
            <div class="text-center mt-4 mb-5">
                <button class="btn btn-primary btn-lg me-3" onclick="resetForm()">
                    <i class="fas fa-plus me-2"></i>Suggest Another Trade
                </button>
                <a href="/my-positions.html" class="btn btn-success btn-lg me-3">
                    <i class="fas fa-chart-line me-2"></i>Track This Trade
                </a>
                <button class="btn btn-danger btn-lg" onclick="deleteTrade()" id="deleteTradeBtn" style="display: none;">
                    <i class="fas fa-trash me-2"></i>Delete Trade
                </button>
            </div>
        </div>

        <!-- My Latest Trade Section (most recent) -->
        <div id="currentTradeSection" class="card mb-4" style="display: none;">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h3 class="mb-0"><i class="fas fa-star me-2 text-warning"></i>My Latest Trade</h3>
            </div>
            <div class="card-body">
                <div id="currentTradeCard" class="row">
                    <!-- Current trade card will be inserted here -->
                </div>
            </div>
        </div>


        <!-- Past Trades Section -->
        <div id="pastTradesSection" class="card mb-4" style="display: none;">
            <div class="card-header d-flex justify-content-between align-items-center" style="cursor: pointer;" onclick="togglePastTrades()">
                <h3 class="mb-0"><i class="fas fa-history me-2"></i>Your Past Trades</h3>
                <div>
                    <span id="tradesCount" class="badge bg-primary me-2">0</span>
                    <i id="toggleIcon" class="fas fa-chevron-down"></i>
                </div>
            </div>
            <div class="card-body">
                <div id="pastTradesLoading" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">Loading your trades...</p>
                </div>
                <div id="pastTradesEmpty" class="text-center py-5" style="display: none;">
                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                    <p class="text-muted">Here you will see your trades</p>
                </div>
                <div id="pastTradesList" class="row" style="display: none;">
                    <!-- Past trades will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration: Set to true to use real AI API, false for mock analysis
        const USE_REAL_AI = true;  // Real AI enabled - connected to Railway backend
        let currentAnalysisResult = null;
        const API_ENDPOINT = '/api/analyze-trade';  // Production Railway API

        async function analyzeTradeWithAI() {
            const tradeName = document.getElementById('tradeName').value.trim();
            const tradeDescription = document.getElementById('tradeDescription').value.trim();
            const includeDerivatives = document.getElementById('includeDerivatives').checked;
            
            if (!tradeName || !tradeDescription) {
                alert('Please fill in both trade name and description');
                return;
            }

            // Show loading state
            document.getElementById('inputForm').style.display = 'none';
            document.getElementById('loadingState').style.display = 'block';

            if (USE_REAL_AI) {
                // Call real AI API
                try {
                    const token = localStorage.getItem('authToken');
                    const response = await fetch(API_ENDPOINT, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            tradeName: tradeName,
                            tradeDescription: tradeDescription,
                            includeDerivatives: includeDerivatives
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`API error: ${response.status}`);
                    }

                    const analysis = await response.json();
                    displayAnalysis(analysis);
                    
                    document.getElementById('loadingState').style.display = 'none';
                    document.getElementById('analysisResults').style.display = 'block';
                    
                    // Reload past trades to update "My Latest Trade" section
                    await loadPastTrades();
                } catch (error) {
                    console.error('AI Analysis Error:', error);
                    
                    // Show error message and reset form
                    document.getElementById('loadingState').style.display = 'none';
                    document.getElementById('inputForm').style.display = 'block';
                    
                    // Show detailed error message
                    alert('Failed to analyze trade. Error: ' + error.message + '\n\nPlease check your connection and try again.');
                }
            } else {
                // Use mock analysis
                setTimeout(() => {
                    const analysis = generateAIAnalysis(tradeName, tradeDescription);
                    displayAnalysis(analysis);
                    
                    document.getElementById('loadingState').style.display = 'none';
                    document.getElementById('analysisResults').style.display = 'block';
                }, 3000);
            }
        }

        function generateAIAnalysis(tradeName, tradeDescription) {
            // Analyze sentiment to determine strategy type
            const text = (tradeName + ' ' + tradeDescription).toLowerCase();
            const bearishKeywords = ['short', 'bubble', 'overvalued', 'crash', 'decline', 'puts', 'bear', 'timing', 'sell'];
            const bullishKeywords = ['long', 'growth', 'buy', 'bull', 'undervalued', 'opportunity'];
            
            const bearishScore = bearishKeywords.filter(keyword => text.includes(keyword)).length;
            const bullishScore = bullishKeywords.filter(keyword => text.includes(keyword)).length;
            
            const isBearish = bearishScore > bullishScore || text.includes('short') || text.includes('bubble');

            if (isBearish) {
                return {
                    tradeName: tradeName,
                    date: new Date().toLocaleDateString(),
                    owner: 'Current User',
                    recommendation: 'RECOMMENDED',
                    riskLevel: 'HIGH',
                    longPositions: [
                        { symbol: 'VIX', name: 'CBOE Volatility Index', allocation: '20%', rationale: 'Hedge against market volatility during AI bubble correction' },
                        { symbol: 'SQQQ', name: 'ProShares UltraPro Short QQQ', allocation: '15%', rationale: 'Triple-leveraged short on tech-heavy NASDAQ' }
                    ],
                    shortPositions: [
                        { symbol: 'NVDA', name: 'NVIDIA Corporation', allocation: '-25%', rationale: 'Most overvalued AI stock with P/E over 60, vulnerable to correction' },
                        { symbol: 'TSLA', name: 'Tesla Inc.', allocation: '-20%', rationale: 'AI/FSD promises not delivering, high valuation unsustainable' },
                        { symbol: 'PLTR', name: 'Palantir Technologies', allocation: '-15%', rationale: 'AI hype stock with limited revenue growth to justify valuation' },
                        { symbol: 'C3AI', name: 'C3.ai Inc.', allocation: '-10%', rationale: 'Pure AI play with massive losses and uncertain path to profitability' }
                    ],
                    returnEstimates: {
                        '1M': { value: '12.5%', rationale: 'Initial market recognition of AI overvaluation begins, early short positions start paying off as sentiment shifts' },
                        '3M': { value: '28.7%', rationale: 'Bubble concerns spread through financial media, institutional investors reduce AI exposure, volatility hedges perform well' },
                        '6M': { value: '45.2%', rationale: 'Major correction in overvalued AI stocks as earnings disappoint, short positions deliver strong returns' },
                        '1Y': { value: '65.8%', rationale: 'Full market repricing of AI valuations to sustainable levels, portfolio benefits from both shorts and volatility positions' },
                        '3Y': { value: '85.4%', rationale: 'Long-term reversion to mean valuations complete, strategy captures extended downtrend in speculative AI names' }
                    },
                    aiRationale: 'This bearish AI bubble strategy targets the most overvalued AI stocks for short positions while using volatility hedges. The thesis is that AI valuations have reached unsustainable levels, with companies trading at extreme multiples without corresponding revenue growth. Short positions focus on pure-play AI stocks with the highest valuations and most speculative business models. The strategy includes volatility hedges to profit from market turbulence during the correction. High risk due to potential for continued irrational exuberance, but strong potential returns if AI bubble deflates.'
                };
            } else {
                return {
                    tradeName: tradeName,
                    date: new Date().toLocaleDateString(),
                    owner: 'Current User',
                    recommendation: 'RECOMMENDED',
                    riskLevel: 'MODERATE',
                    longPositions: [
                        { symbol: 'NVDA', name: 'NVIDIA Corporation', allocation: '25%', rationale: 'Leading AI chip manufacturer with strong moat' },
                        { symbol: 'MSFT', name: 'Microsoft Corporation', allocation: '20%', rationale: 'Azure AI services and OpenAI partnership' },
                        { symbol: 'GOOGL', name: 'Alphabet Inc.', allocation: '15%', rationale: 'Advanced AI research and cloud infrastructure' }
                    ],
                    shortPositions: [
                        { symbol: 'TLPFY', name: 'Teleperformance SE', allocation: '-15%', rationale: 'Call center services vulnerable to AI automation' },
                        { symbol: 'HRB', name: 'H&R Block Inc.', allocation: '-10%', rationale: 'Tax preparation being automated by AI tools' }
                    ],
                    returnEstimates: {
                        '1M': { value: '8.5%', rationale: 'Strong AI earnings reports drive initial momentum, market recognizes AI infrastructure value' },
                        '3M': { value: '15.2%', rationale: 'AI adoption accelerates across enterprises, revenue growth validates high valuations for leaders' },
                        '6M': { value: '28.7%', rationale: 'AI beneficiaries report expanding margins, disruption of traditional industries becomes evident' },
                        '1Y': { value: '45.3%', rationale: 'AI revolution fully underway, long positions compound gains while shorts on disrupted sectors pay off' },
                        '3Y': { value: '125.8%', rationale: 'Multi-year AI transformation creates sustained growth for technology leaders and persistent decline for disrupted industries' }
                    },
                    aiRationale: 'This AI disruption strategy capitalizes on the transformative impact of artificial intelligence across industries. The long positions target companies that are either developing AI technology (NVIDIA\'s chips, Microsoft\'s Azure AI) or successfully integrating AI into their business models. The short positions focus on traditional service industries that face significant disruption from AI automation. The risk is moderate due to diversification across multiple AI beneficiaries, though technology sector volatility should be expected.'
                };
            }
        }

        function displayAnalysis(analysis) {
            document.getElementById('resultTradeName').textContent = analysis.tradeName;
            
            // Get user info from localStorage or use default
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            const ownerName = user.name || user.email || 'You';
            document.getElementById('resultOwner').textContent = ownerName;
            
            // Format date properly
            const date = analysis.date ? new Date(analysis.date) : new Date();
            document.getElementById('resultDate').textContent = date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
            
            // Use sentiment instead of recommendation
            const sentiment = analysis.sentiment || 'NEUTRAL';
            const sentimentBadge = document.getElementById('resultRecommendation');
            sentimentBadge.textContent = sentiment;
            
            // Sentiment badge colors
            sentimentBadge.className = 'badge me-2';
            if (sentiment === 'BULLISH') {
                sentimentBadge.classList.add('bg-success');
            } else if (sentiment === 'BEARISH') {
                sentimentBadge.classList.add('bg-danger');
            } else {
                sentimentBadge.classList.add('bg-secondary');
            }
            
            document.getElementById('resultRisk').textContent = 'Risk: ' + analysis.riskLevel;

            // Return estimates with rationales (now in separate fields)
            const returnGrid = document.getElementById('returnGrid');
            returnGrid.innerHTML = '';
            
            // Build detailed rationale text
            let rationaleHTML = '<div class="row g-3">';
            
            // Safety check for returnEstimates
            if (analysis.returnEstimates && typeof analysis.returnEstimates === 'object') {
                // Define order: 1M, 6M, 1Y, 3Y
                const periodOrder = ['1M', '6M', '1Y', '3Y'];
                periodOrder.forEach(period => {
                const value = analysis.returnEstimates[period];
                if (!value) return; // Skip if period not available
                // Get rationale from separate returnRationales object
                const rationale = analysis.returnRationales ? analysis.returnRationales[period] : '';
                
                // Create return card with tooltip
                const card = document.createElement('div');
                card.className = 'return-card';
                card.style.cursor = 'pointer';
                card.setAttribute('data-bs-toggle', 'tooltip');
                card.setAttribute('data-bs-placement', 'top');
                card.setAttribute('title', rationale || 'Expected return for this time period');
                // Remove decimal points from percentages (3.5% â†’ 4%, 25.0% â†’ 25%)
                const displayValue = value.replace(/\.\d+%/, '%').replace(/(\d+)%/, (match, num) => Math.round(parseFloat(num)) + '%');
                card.innerHTML = `<h3>${displayValue}</h3><p>${period}</p>`;
                returnGrid.appendChild(card);
                
                // Add to detailed rationale section
                if (rationale) {
                    rationaleHTML += `
                        <div class="col-12">
                            <div class="p-3 bg-white rounded border-start border-4 border-primary">
                                <strong class="text-primary">${period} (${value}):</strong>
                                <p class="mb-0 mt-2 text-muted">${rationale}</p>
                            </div>
                        </div>
                    `;
                }
                });
            }
            
            rationaleHTML += '</div>';
            document.getElementById('returnRationaleText').innerHTML = rationaleHTML;
            
            // Initialize Bootstrap tooltips
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });

            // Smart Position Categorization - Only show sections that have positions
            // Long positions
            if (analysis.longs && analysis.longs.length > 0) {
                document.getElementById('longPositionsCard').style.display = 'block';
                displayPositionsWithCharts(analysis.longs, 'longPositions', true);
            } else {
                document.getElementById('longPositionsCard').style.display = 'none';
            }

            // Short positions
            if (analysis.shorts && analysis.shorts.length > 0) {
                document.getElementById('shortPositionsCard').style.display = 'block';
                displayPositionsWithCharts(analysis.shorts, 'shortPositions', false);
            } else {
                document.getElementById('shortPositionsCard').style.display = 'none';
            }
            
            // Derivatives (if any)
            if (analysis.derivatives && analysis.derivatives.length > 0) {
                document.getElementById('derivativesCard').style.display = 'block';
                displayPositionsWithCharts(analysis.derivatives, 'derivativePositions', true);
            } else {
                document.getElementById('derivativesCard').style.display = 'none';
            }

            // AI rationale (moved BEFORE metrics per user request)
            document.getElementById('aiRationale').textContent = analysis.aiRationale;
            
            // Portfolio Metrics - now in dedicated container
            if (analysis.portfolioMetrics) {
                const metrics = analysis.portfolioMetrics;
                let metricsHTML = `
                    <h5 class="mb-3"><i class="fas fa-wallet me-2"></i>Investment Required & Portfolio Metrics</h5>
                    
                    <!-- Investment Breakdown -->
                    <div class="p-3 mb-3" style="background: #f8f9fa; border-radius: 10px; border-left: 4px solid #667eea;">
                        <h6 class="mb-3">Investment Breakdown</h6>
                        <div class="row g-2 mb-3">
                            <div class="col-md-4">
                                <div class="p-2 bg-white rounded">
                                    <div class="text-muted small">Long Positions</div>
                                    <div class="fw-bold text-success">${metrics.long_exposure || 'N/A'}%</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="p-2 bg-white rounded">
                                    <div class="text-muted small">Short Positions</div>
                                    <div class="fw-bold text-danger">${metrics.short_exposure || 'N/A'}%</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="p-2 bg-white rounded" style="border: 2px solid #667eea;">
                                    <div class="text-muted small">Net Investment</div>
                                    <div class="fw-bold text-primary">${metrics.net_exposure || 'N/A'}%</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="p-3 bg-white rounded border">
                            <h6 class="mb-2">For $1,000 Investment:</h6>
                            <div class="mb-2"><strong>Net Capital Required:</strong> <span class="text-primary fs-5">$${metrics.net_capital_required || 'N/A'}</span></div>
                            <div class="text-muted small">
                                <div class="mb-1"><strong>Calculation:</strong></div>
                `;
                
                if (metrics.calculation_steps && Array.isArray(metrics.calculation_steps)) {
                    metrics.calculation_steps.forEach(step => {
                        metricsHTML += `<div class="ms-3">â€¢ ${step}</div>`;
                    });
                }
                
                metricsHTML += `
                            </div>
                        </div>
                    </div>
                    
                    <!-- Portfolio Metrics Grid -->
                    <div class="row g-3">
                        <div class="col-md-3">
                            <div class="p-3 text-center" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; color: white;">
                                <div class="small mb-1">Portfolio Beta</div>
                                <div class="fw-bold fs-4">${metrics.portfolio_beta || 'N/A'}</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="p-3 text-center" style="background: linear-gradient(135deg, #4caf50 0%, #45a049 100%); border-radius: 10px; color: white;">
                                <div class="small mb-1">Alpha</div>
                                <div class="fw-bold fs-4">${analysis.alpha || metrics.alpha || 'N/A'}%</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="p-3 text-center" style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); border-radius: 10px; color: white;">
                                <div class="small mb-1">Net Exposure</div>
                                <div class="fw-bold fs-4">${metrics.net_exposure || 'N/A'}%</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="p-3 text-center" style="background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%); border-radius: 10px; color: white;">
                                <div class="small mb-1">Gross Exposure</div>
                                <div class="fw-bold fs-4">${metrics.gross_exposure || 'N/A'}%</div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Insert into dedicated container
                document.getElementById('portfolioMetricsContainer').innerHTML = metricsHTML;
            }
        }

        function displayPositionsWithCharts(positions, containerId, isLong) {
            console.log('[displayPositionsWithCharts] START - containerId:', containerId);
            const container = document.getElementById(containerId);
            console.log('[displayPositionsWithCharts] Container found:', container);
            container.innerHTML = '';
            
            // Safety check for positions array
            if (!positions || !Array.isArray(positions) || positions.length === 0) {
                console.log('[displayPositionsWithCharts] No positions, returning');
                container.innerHTML = '<p class="text-muted">No positions available</p>';
                return;
            }
            console.log('[displayPositionsWithCharts] Processing', positions.length, 'positions');
            
            positions.forEach((position, index) => {
                console.log('[displayPositionsWithCharts] Processing position', index, ':', position.ticker);
                const card = document.createElement('div');
                card.className = `position-card ${isLong ? 'long-position' : 'short-position'}`;
                
                // FIXED: Data is directly on position object after backend enrichment
                // Check if we have valid financial data or need mock data
                const hasValidData = position.currentPrice && position.currentPrice > 0;
                const mockData = hasValidData ? null : generateMockFinancialData(position.ticker);
                
                // Extract data directly from position object (not nested)
                const priceChange = hasValidData ? (position.priceChangePercent || position.priceChange || 0) : mockData.priceChange;
                const currentPrice = hasValidData ? `$${position.currentPrice.toFixed(2)}` : mockData.price;
                const marketCap = hasValidData ? (position.marketCap || 'N/A') : mockData.marketCap;
                const pe = hasValidData && position.pe ? position.pe.toFixed(2) : (mockData ? mockData.pe : 'N/A');
                const ps = hasValidData && position.ps ? position.ps.toFixed(2) : (mockData ? mockData.ps : 'N/A');
                const pb = hasValidData && position.pb ? position.pb.toFixed(2) : (mockData ? mockData.pb : 'N/A');
                const evEbitda = hasValidData && position.evEbitda ? position.evEbitda.toFixed(2) : (mockData ? mockData.ev_ebitda : 'N/A');
                
                card.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div>
                            <span class="badge ${isLong ? 'bg-success' : 'bg-danger'}">${position.ticker}</span>
                            <strong class="ms-2">${position.name}</strong>
                        </div>
                        <span class="badge ${isLong ? 'bg-success' : 'bg-danger'}">${position.allocation} ${isLong ? 'Long' : 'Short'}</span>
                    </div>
                    
                    <!-- Position Rationale (ABOVE chart, prominent) -->
                    <div class="mb-3 p-3" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border-left: 4px solid ${isLong ? '#28a745' : '#dc3545'}; border-radius: 8px;">
                        <p class="mb-0" style="font-size: 1.05rem; line-height: 1.6; color: #1565c0;"><strong>${position.rationale}</strong></p>
                    </div>
                    
                    <!-- Stock Chart - TradingView Widget -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <small class="text-muted">Price Chart</small>
                            <span class="badge ${priceChange >= 0 ? 'bg-success' : 'bg-danger'}">
                                ${priceChange >= 0 ? '+' : ''}${priceChange.toFixed(1)}%
                            </span>
                        </div>
                        <div id="tradingview-chart-${position.ticker}" style="height: 400px; border-radius: 8px; overflow: hidden;"></div>
                    </div>
                    
                    <!-- Key Metrics (Only Available) -->
                    <div class="mb-3">
                        <h6 class="text-muted mb-2">Key Metrics</h6>
                        <div class="row g-2">
                            ${currentPrice !== 'N/A' ? `
                            <div class="col-6 col-md-4">
                                <div class="d-flex justify-content-between p-2" style="background: rgba(108,117,125,0.05); border-radius: 6px;">
                                    <small class="text-muted">Current Price</small>
                                    <strong>${currentPrice}</strong>
                                </div>
                            </div>
                            ` : ''}
                            ${marketCap !== 'N/A' ? `
                            <div class="col-6 col-md-4">
                                <div class="d-flex justify-content-between p-2" style="background: rgba(108,117,125,0.05); border-radius: 6px;">
                                    <small class="text-muted">Market Cap</small>
                                    <strong>${marketCap}</strong>
                                </div>
                            </div>
                            ` : ''}
                            ${pe !== 'N/A' ? `
                            <div class="col-6 col-md-4">
                                <div class="d-flex justify-content-between p-2" style="background: rgba(108,117,125,0.05); border-radius: 6px;">
                                    <small class="text-muted">Price-to-Earnings</small>
                                    <strong>${pe}</strong>
                                </div>
                            </div>
                            ` : ''}
                            ${ps !== 'N/A' ? `
                            <div class="col-6 col-md-4">
                                <div class="d-flex justify-content-between p-2" style="background: rgba(108,117,125,0.05); border-radius: 6px;">
                                    <small class="text-muted">Price-to-Sales</small>
                                    <strong>${ps}</strong>
                                </div>
                            </div>
                            ` : ''}
                            ${pb !== 'N/A' ? `
                            <div class="col-6 col-md-4">
                                <div class="d-flex justify-content-between p-2" style="background: rgba(108,117,125,0.05); border-radius: 6px;">
                                    <small class="text-muted">Price-to-Book</small>
                                    <strong>${pb}</strong>
                                </div>
                            </div>
                            ` : ''}
                            ${evEbitda !== 'N/A' ? `
                            <div class="col-6 col-md-4">
                                <div class="d-flex justify-content-between p-2" style="background: rgba(108,117,125,0.05); border-radius: 6px;">
                                    <small class="text-muted">EV/EBITDA</small>
                                    <strong>${evEbitda}</strong>
                                </div>
                            </div>
                            ` : ''}
                            ${position.beta && position.beta !== 'N/A' ? `
                            <div class="col-6 col-md-4">
                                <div class="d-flex justify-content-between p-2" style="background: rgba(108,117,125,0.05); border-radius: 6px;">
                                    <small class="text-muted">Beta</small>
                                    <strong>${position.beta}</strong>
                                </div>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    

                `;
                console.log('[displayPositionsWithCharts] Appending card for', position.ticker);
                container.appendChild(card);
                console.log('[displayPositionsWithCharts] Card appended successfully');
                
                // Initialize TradingView chart after element is added to DOM
                setTimeout(() => initTradingViewChart(position.ticker, position), 500);
            });
        }
        
        function initTradingViewChart(symbol, financialData) {
            const containerId = `tradingview-chart-${symbol}`;
            const container = document.getElementById(containerId);
            if (!container) return;
            
            // Clear any existing widget
            container.innerHTML = '';
            
            // Initialize TradingView widget
            new TradingView.widget({
                "autosize": true,
                "symbol": symbol,  // Let TradingView auto-detect the exchange
                "interval": "D",
                "timezone": "Etc/UTC",
                "theme": "light",
                "style": "1",
                "locale": "en",
                "toolbar_bg": "#f1f3f6",
                "enable_publishing": false,
                "allow_symbol_change": false,
                "container_id": containerId,
                "hide_top_toolbar": false,
                "hide_legend": false,
                "save_image": false,
                "studies": [],
                "show_popup_button": false,
                "popup_width": "1000",
                "popup_height": "650",
                "support_host": "https://www.tradingview.com"
            });
        }

        function generateMockFinancialData(symbol) {
            // Mock financial data based on symbol
            const dataMap = {
                'NVDA': { pe: '65.2', ps: '22.1', pb: '13.8', ev_ebitda: '45.3', price: '$875.28', marketCap: '$2.15T', priceChange: 145.7 },
                'TSLA': { pe: '73.1', ps: '8.9', pb: '9.2', ev_ebitda: '52.7', price: '$248.50', marketCap: '$791B', priceChange: -12.3 },
                'MSFT': { pe: '28.4', ps: '11.2', pb: '4.1', ev_ebitda: '18.9', price: '$378.85', marketCap: '$2.81T', priceChange: 23.4 },
                'GOOGL': { pe: '21.8', ps: '4.8', pb: '3.2', ev_ebitda: '12.1', price: '$138.21', marketCap: '$1.75T', priceChange: 18.9 },
                'PLTR': { pe: '195.4', ps: '18.7', pb: '7.3', ev_ebitda: 'N/A', price: '$23.45', marketCap: '$51.2B', priceChange: -8.7 },
                'C3AI': { pe: 'N/A', ps: '21.3', pb: '4.8', ev_ebitda: 'N/A', price: '$28.91', marketCap: '$3.2B', priceChange: -15.2 },
                'VIX': { pe: 'N/A', ps: 'N/A', pb: 'N/A', ev_ebitda: 'N/A', price: '$14.23', marketCap: 'N/A', priceChange: 8.4 },
                'SQQQ': { pe: 'N/A', ps: 'N/A', pb: 'N/A', ev_ebitda: 'N/A', price: '$8.45', marketCap: '$1.8B', priceChange: -45.2 },
                'TLPFY': { pe: '12.8', ps: '1.4', pb: '2.1', ev_ebitda: '8.9', price: '$18.67', marketCap: '$12.4B', priceChange: -5.3 },
                'HRB': { pe: '11.2', ps: '2.1', pb: '1.8', ev_ebitda: '7.4', price: '$58.23', marketCap: '$9.8B', priceChange: 2.1 }
            };
            
            return dataMap[symbol] || { pe: 'N/A', ps: 'N/A', pb: 'N/A', ev_ebitda: 'N/A', price: '$0.00', marketCap: 'N/A', priceChange: 0 };
        }

        function drawMockChart(symbol, data) {
            const canvas = document.getElementById(`chart-${symbol}`);
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const width = canvas.offsetWidth;
            const height = 350;
            canvas.width = width;
            canvas.height = height;
            
            // Generate mock price data (6 months)
            const points = 180; // 6 months of daily data
            const priceData = [];
            let basePrice = parseFloat(data.price.replace('$', '').replace(',', '')) || 100;
            let currentPrice = basePrice / (1 + data.priceChange / 100); // Starting price
            
            for (let i = 0; i < points; i++) {
                // Add some volatility
                const volatility = (Math.random() - 0.5) * 0.04; // Â±2% daily volatility
                const trend = (data.priceChange / 100) / points; // Distribute total change over period
                currentPrice *= (1 + trend + volatility);
                priceData.push(currentPrice);
            }
            
            // Chart margins for axes
            const marginLeft = 60;
            const marginRight = 20;
            const marginTop = 20;
            const marginBottom = 40;
            const chartWidth = width - marginLeft - marginRight;
            const chartHeight = height - marginTop - marginBottom;
            
            // Draw chart
            ctx.clearRect(0, 0, width, height);
            
            // Chart background
            ctx.fillStyle = 'rgba(255, 255, 255, 0.95)';
            ctx.fillRect(0, 0, width, height);
            
            // Price line
            const minPrice = Math.min(...priceData);
            const maxPrice = Math.max(...priceData);
            const priceRange = maxPrice - minPrice;
            
            // Draw grid lines
            ctx.strokeStyle = '#e9ecef';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 5; i++) {
                const y = marginTop + (chartHeight / 5) * i;
                ctx.beginPath();
                ctx.moveTo(marginLeft, y);
                ctx.lineTo(marginLeft + chartWidth, y);
                ctx.stroke();
            }
            
            // Draw Y-axis
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(marginLeft, marginTop);
            ctx.lineTo(marginLeft, marginTop + chartHeight);
            ctx.stroke();
            
            // Draw X-axis
            ctx.beginPath();
            ctx.moveTo(marginLeft, marginTop + chartHeight);
            ctx.lineTo(marginLeft + chartWidth, marginTop + chartHeight);
            ctx.stroke();
            
            // Draw Y-axis labels (prices)
            ctx.fillStyle = '#666';
            ctx.font = '12px Arial';
            ctx.textAlign = 'right';
            for (let i = 0; i <= 5; i++) {
                const price = maxPrice - (priceRange / 5) * i;
                const y = marginTop + (chartHeight / 5) * i;
                ctx.fillText('$' + price.toFixed(2), marginLeft - 5, y + 4);
            }
            
            // Draw X-axis labels (mock dates)
            ctx.textAlign = 'center';
            const today = new Date();
            const sixMonthsAgo = new Date(today);
            sixMonthsAgo.setMonth(today.getMonth() - 6);
            const threeMonthsAgo = new Date(today);
            threeMonthsAgo.setMonth(today.getMonth() - 3);
            
            ctx.fillText(sixMonthsAgo.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }), marginLeft, marginTop + chartHeight + 25);
            ctx.fillText(threeMonthsAgo.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }), marginLeft + chartWidth / 2, marginTop + chartHeight + 25);
            ctx.fillText(today.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }), marginLeft + chartWidth, marginTop + chartHeight + 25);
            
            // Draw price line
            ctx.beginPath();
            ctx.strokeStyle = data.priceChange >= 0 ? '#28a745' : '#dc3545';
            ctx.lineWidth = 3;
            
            priceData.forEach((price, index) => {
                const x = marginLeft + (index / (points - 1)) * chartWidth;
                const y = marginTop + chartHeight - ((price - minPrice) / priceRange) * chartHeight;
                
                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            
            ctx.stroke();
            
            // Fill area under curve
            ctx.lineTo(marginLeft + chartWidth, marginTop + chartHeight);
            ctx.lineTo(marginLeft, marginTop + chartHeight);
            ctx.closePath();
            ctx.fillStyle = data.priceChange >= 0 ? 'rgba(40, 167, 69, 0.15)' : 'rgba(220, 53, 69, 0.15)';
            ctx.fill();
        }

        
        function saveTradeToMyPositions() {
            if (!currentAnalysisResult) {
                alert('No analysis to save');
                return;
            }
            
            // Show investment modal
            showInvestmentModal();
        }
        
        function showInvestmentModal() {
            const modal = document.getElementById('investmentModal');
            if (modal) {
                modal.style.display = 'flex';
            }
        }
        
        function closeInvestmentModal() {
            const modal = document.getElementById('investmentModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        async function confirmSaveTrade() {
            const amount = document.getElementById('saveInvestAmount').value;
            const currency = document.getElementById('saveCurrency').value;
            
            // Get existing trades
            const trades = JSON.parse(localStorage.getItem('myTrades') || '[]');
            
            // Create trade object
            const trade = {
                tradeName: document.getElementById('tradeName').value,
                tradeDescription: document.getElementById('tradeDescription').value,
                investmentAmount: amount || '',
                currency: currency || 'USD',
                recommendation: currentAnalysisResult.recommendation,
                risk: currentAnalysisResult.risk,
                rationale: currentAnalysisResult.rationale,
                positions: currentAnalysisResult.positions,
                returnEstimates: currentAnalysisResult.returnEstimates,
                createdAt: new Date().toISOString()
            };
            
            // Add to trades
            trades.unshift(trade);
            localStorage.setItem('myTrades', JSON.stringify(trades));
            
            // Close modal
            closeInvestmentModal();
            
            // Show success
            alert('Trade saved successfully!');
            
            // Update button
            const btn = document.getElementById('saveTradeBtn');
            if (btn) {
                btn.innerHTML = '<i class="fas fa-check me-2"></i>Saved!';
                btn.disabled = true;
            }
            
            // Reload past trades to show new trade in My Latest Trade section
            await loadPastTrades();
            
            // Scroll to My Latest Trade section
            const currentTradeSection = document.getElementById('currentTradeSection');
            if (currentTradeSection && currentTradeSection.style.display !== 'none') {
                currentTradeSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }


        function resetForm() {
            document.getElementById('tradeName').value = '';
            document.getElementById('tradeDescription').value = '';
            document.getElementById('inputForm').style.display = 'block';
            document.getElementById('analysisResults').style.display = 'none';
        }

        function trackTrade() {
            if (!currentAnalysisResult) {
                alert('No trade analysis to track');
                return;
            }
            
            const trades = JSON.parse(localStorage.getItem('myTrades') || '[]');
            
            // Check if trade already exists
            const existingIndex = trades.findIndex(t => t.tradeName === currentAnalysisResult.tradeName);
            if (existingIndex > -1) {
                trades[existingIndex] = currentAnalysisResult;
                alert('Trade updated successfully!');
            } else {
                trades.push(currentAnalysisResult);
                alert('Trade tracked successfully! View it in My Positions.');
            }
            
            localStorage.setItem('myTrades', JSON.stringify(trades));
            
            // Show delete button after tracking
            document.getElementById('deleteTradeBtn').style.display = 'inline-block';
        }

        function deleteTrade() {
            if (!currentAnalysisResult) {
                alert('No trade to delete');
                return;
            }
            
            if (!confirm('Are you sure you want to delete this trade? This action cannot be undone.')) {
                return;
            }
            
            const trades = JSON.parse(localStorage.getItem('myTrades') || '[]');
            const tradeName = currentAnalysisResult.tradeName;
            const updatedTrades = trades.filter(t => t.tradeName !== tradeName);
            localStorage.setItem('myTrades', JSON.stringify(updatedTrades));
            
            alert('Trade deleted successfully!');
            resetForm();
        }

        // Toggle Past Trades visibility
        function togglePastTrades() {
            const list = document.getElementById('pastTradesList');
            const icon = document.getElementById('toggleIcon');
            
            if (list.style.display === 'none') {
                list.style.display = 'block';
                icon.className = 'fas fa-chevron-up';
            } else {
                list.style.display = 'none';
                icon.className = 'fas fa-chevron-down';
            }
        }
        
        // Load past trades on page load
        async function loadPastTrades() {
            const token = localStorage.getItem('authToken');
            if (!token) {
                console.log('No auth token, skipping past trades load');
                return;
            }
            
            const section = document.getElementById('pastTradesSection');
            const loading = document.getElementById('pastTradesLoading');
            const empty = document.getElementById('pastTradesEmpty');
            const list = document.getElementById('pastTradesList');
            const count = document.getElementById('tradesCount');
            
            section.style.display = 'block';
            loading.style.display = 'block';
            empty.style.display = 'none';
            list.style.display = 'none';
            
            try {
                const response = await fetch('/api/trades', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                const trades = data.trades || [];
                
                loading.style.display = 'none';
                
                if (trades.length === 0) {
                    empty.style.display = 'block';
                    empty.innerHTML = `
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Here you will see your trades</p>
                    `;
                    count.textContent = '0';
                } else {
                    list.style.display = 'block';
                    count.textContent = trades.length;
                    displayPastTrades(trades);
                }
            } catch (error) {
                console.error('Error loading past trades:', error);
                loading.style.display = 'none';
                empty.style.display = 'block';
                
                // Show detailed error message
                let errorMsg = 'Unable to load past trades.';
                if (error.message.includes('401')) {
                    errorMsg = 'Please log in to view your trades.';
                } else if (error.message.includes('403')) {
                    errorMsg = 'Access denied. Please log in again.';
                } else if (error.message.includes('404')) {
                    errorMsg = 'Trades endpoint not found.';
                } else if (error.message.includes('500')) {
                    errorMsg = 'Server error. Please try again later.';
                }
                
                empty.innerHTML = `
                    <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                    <p class="text-muted">${errorMsg}</p>
                    <p class="text-muted small">Error: ${error.message}</p>
                `;
            }
        }
        
        function displayPastTrades(trades) {
            const currentTradeSection = document.getElementById('currentTradeSection');
            const currentTradeCard = document.getElementById('currentTradeCard');
            const pastTradesSection = document.getElementById('pastTradesSection');
            const list = document.getElementById('pastTradesList');
            
            list.innerHTML = '';
            currentTradeCard.innerHTML = '';
            
            // Sort by date, newest first
            trades.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            // Separate current trade (newest) from past trades
            const currentTrade = trades[0];
            const pastTrades = trades.slice(1);
            
            // Display current trade
            if (currentTrade) {
                currentTradeSection.style.display = 'block';
                const card = createTradeCard(currentTrade);
                currentTradeCard.appendChild(card);
            } else {
                currentTradeSection.style.display = 'none';
            }
            
            // Display past trades
            if (pastTrades.length > 0) {
                pastTradesSection.style.display = 'block';
                document.getElementById('tradesCount').textContent = pastTrades.length;
                // Start collapsed, user can click to expand
                document.getElementById('pastTradesList').style.display = 'none';
                document.getElementById('pastTradesEmpty').style.display = 'none';
            } else {
                // If no past trades, show empty state
                pastTradesSection.style.display = 'block';
                document.getElementById('pastTradesEmpty').style.display = 'block';
                document.getElementById('pastTradesList').style.display = 'none';
            }
            
            pastTrades.forEach(trade => {
                const card = createTradeCard(trade);
                list.appendChild(card);
            });
        }
        
        function createTradeCard(trade) {
            const date = new Date(trade.createdAt).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
            
            const sentiment = trade.sentiment || 'NEUTRAL';
            const riskLevel = trade.riskLevel || 'UNKNOWN';
            
            // Sentiment badge colors
            const sentimentColor = {
                'BULLISH': 'success',
                'BEARISH': 'danger',
                'NEUTRAL': 'secondary'
            }[sentiment] || 'secondary';
            
            // Risk badge colors
            const riskColor = {
                'LOW': 'success',
                'MODERATE': 'warning',
                'HIGH': 'danger',
                'VERY HIGH': 'danger',
                'UNKNOWN': 'secondary'
            }[riskLevel] || 'secondary';
            
            // Get return estimates (use new periods: 1M, 6M, 1Y, 3Y)
            const returns = trade.returnEstimates || {};
            const return1M = returns['1M'] || 'N/A';
            const return6M = returns['6M'] || returns['3M'] || 'N/A';
            const return1Y = returns['1Y'] || returns['6M'] || 'N/A';
            const return3Y = returns['3Y'] || returns['1Y'] || 'N/A';
            
            // Get position tickers
            const longs = trade.longs || [];
            const shorts = trade.shorts || [];
            const longTickers = longs.map(p => p.ticker).slice(0, 4);
            const shortTickers = shorts.map(p => p.ticker).slice(0, 4);
            
            // Mock data for now
            const rating = 4.5;
            const investors = 342;
            
            const card = document.createElement('div');
            card.className = 'col-12 mb-3';
            card.innerHTML = `
                <div class="card trade-card-detailed" style="border-radius: 15px; overflow: hidden;">
                    <div class="card-body p-4">
                        <!-- Header -->
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div>
                                <h5 class="mb-1" style="font-weight: 600;">${escapeHtml(trade.trade_name || trade.name || 'Untitled Trade')}</h5>
                                <p class="text-muted small mb-0">by ${escapeHtml(trade.owner || 'Anonymous')} â€¢ ${date}</p>
                            </div>
                        </div>
                        
                        <!-- Badges -->
                        <div class="d-flex gap-2 mb-3 flex-wrap">
                            <span class="badge" style="background-color: ${sentimentColor === 'success' ? '#d4edda' : sentimentColor === 'danger' ? '#f8d7da' : '#e2e3e5'}; color: ${sentimentColor === 'success' ? '#155724' : sentimentColor === 'danger' ? '#721c24' : '#383d41'}; padding: 0.5rem 1rem; border-radius: 20px; font-weight: 600;">${sentiment}</span>
                            <span class="badge" style="background-color: ${riskColor === 'success' ? '#d4edda' : riskColor === 'warning' ? '#fff3cd' : '#f8d7da'}; color: ${riskColor === 'success' ? '#155724' : riskColor === 'warning' ? '#856404' : '#721c24'}; padding: 0.5rem 1rem; border-radius: 20px; font-weight: 600;">${riskLevel} RISK</span>
                            <span class="text-warning" style="font-size: 1.1rem;">
                                ${'â˜…'.repeat(Math.floor(rating))}${'â˜†'.repeat(5 - Math.floor(rating))} ${rating}
                            </span>
                            <span class="text-muted">
                                <i class="fas fa-users"></i> ${investors} investors
                            </span>
                        </div>
                        
                        <!-- Position Tickers -->
                        <div class="mb-3">
                            ${longTickers.length > 0 ? `
                            <div class="mb-2">
                                <span class="text-success me-2"><i class="fas fa-arrow-up"></i> Long:</span>
                                ${longTickers.map(t => `<span class="badge bg-success bg-opacity-25 text-success me-1" style="padding: 0.4rem 0.8rem;">${t}</span>`).join('')}
                                ${longs.length > 4 ? `<span class="text-muted small">+${longs.length - 4} more</span>` : ''}
                            </div>
                            ` : ''}
                            ${shortTickers.length > 0 ? `
                            <div>
                                <span class="text-danger me-2"><i class="fas fa-arrow-down"></i> Short:</span>
                                ${shortTickers.map(t => `<span class="badge bg-danger bg-opacity-25 text-danger me-1" style="padding: 0.4rem 0.8rem;">${t}</span>`).join('')}
                                ${shorts.length > 4 ? `<span class="text-muted small">+${shorts.length - 4} more</span>` : ''}
                            </div>
                            ` : ''}
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="d-flex gap-2">
                            <button class="btn btn-primary" onclick="event.stopPropagation(); alert('Invest feature coming soon!')" style="border-radius: 10px; padding: 0.5rem 1.5rem;">
                                <i class="fas fa-plus"></i> Invest
                            </button>
                            <button class="btn btn-outline-primary" onclick="event.stopPropagation(); viewTradeDetails(${trade.id})" style="border-radius: 10px; padding: 0.5rem 1.5rem;">
                                <i class="fas fa-eye"></i> View Details
                            </button>
                        </div>
                    </div>
                </div>
            `;
            return card;
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        async function viewTradeDetails(tradeId) {
            try {
                // Fetch the trade details from the server
                const response = await fetch(`/api/trades/${tradeId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load trade details');
                }
                
                const trade = await response.json();
                
                // Display the trade in the analysis results section
                displayAnalysis(trade);
                displayPositionsWithCharts(trade);
                
                // Show the analysis results section
                document.getElementById('analysisResults').style.display = 'block';
                
                // Scroll to the analysis results section
                document.getElementById('analysisResults').scrollIntoView({ behavior: 'smooth', block: 'start' });
            } catch (error) {
                console.error('Error loading trade details:', error);
                alert('Failed to load trade details. Please try again.');
            }
        }
        
        // Load past trades when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Wait a bit for auth check to complete
            setTimeout(loadPastTrades, 500);
        });

    </script>
    <!-- Footer -->
    <footer class="mt-5 py-4 text-white text-center">
        <div class="container">
            <p class="mb-2">Â© 2025 RationalMarkets - Educational Platform for AI Investment Strategy Learning</p>
            <div class="d-flex justify-content-center gap-3 mb-2">
                <a href="disclaimer.html" class="text-white text-decoration-none">Legal Disclaimer</a>
                <a href="index.html" class="text-white text-decoration-none">Home</a>
            </div>
            <p class="small mb-0" style="opacity: 0.8;">
                <strong>Educational Notice:</strong> Not investment advice â€¢ Educational purposes only
            </p>
        </div>
    </footer>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Investment Modal -->
    <div id="investmentModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; justify-content: center; align-items: center;">
        <div style="background: white; padding: 2rem; border-radius: 15px; max-width: 500px; width: 90%;">
            <h3 style="margin-bottom: 1.5rem;"><i class="fas fa-wallet me-2"></i>Investment Amount (Optional)</h3>
            <p style="color: #666; margin-bottom: 1.5rem;">Enter the amount you plan to invest in this trade. This helps track your portfolio allocation.</p>
            
            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; font-weight: bold; margin-bottom: 0.5rem;">Currency</label>
                <select id="saveCurrency" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;">
                    <option value="USD">$ USD</option>
                    <option value="EUR">â‚¬ EUR</option>
                </select>
            </div>
            
            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; font-weight: bold; margin-bottom: 0.5rem;">Amount</label>
                <input type="number" id="saveInvestAmount" placeholder="e.g., 10000" min="0" step="100" 
                       style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;">
            </div>
            
            <div style="display: flex; gap: 1rem;">
                <button onclick="confirmSaveTrade()" style="flex: 1; background: #667eea; color: white; border: none; padding: 0.75rem; border-radius: 8px; font-weight: 600; cursor: pointer;">
                    <i class="fas fa-check me-2"></i>Save Trade
                </button>
                <button onclick="closeInvestmentModal()" style="flex: 1; background: #e0e0e0; color: #333; border: none; padding: 0.75rem; border-radius: 8px; font-weight: 600; cursor: pointer;">
                    Cancel
                </button>
            </div>
        </div>
    </div>

<script>
// Debug script - add console logging to key functions
(function() {
    console.log("=== DEBUG SCRIPT LOADED ===");
    
    // Wait for page to load
    window.addEventListener("DOMContentLoaded", function() {
        console.log("DOM loaded, setting up interceptors...");
        
        // Intercept displayAnalysis
        const originalDisplayAnalysis = window.displayAnalysis;
        if (originalDisplayAnalysis) {
            window.displayAnalysis = function(analysis) {
                console.log("=== displayAnalysis called ===");
                console.log("Analysis:", analysis);
                console.log("Longs:", analysis.longs);
                console.log("Shorts:", analysis.shorts);
                return originalDisplayAnalysis.apply(this, arguments);
            };
            console.log("displayAnalysis interceptor installed");
        } else {
            console.log("WARNING: displayAnalysis not found");
        }
        
        // Intercept displayPositionsWithCharts
        const originalDisplayPositions = window.displayPositionsWithCharts;
        if (originalDisplayPositions) {
            window.displayPositionsWithCharts = function(positions, containerId, isLong) {
                console.log("=== displayPositionsWithCharts called ===");
                console.log("Container:", containerId, "isLong:", isLong);
                console.log("Positions:", positions);
                if (positions && positions.length > 0) {
                    console.log("First position:", positions[0]);
                    console.log("  ticker:", positions[0].ticker);
                    console.log("  currentPrice:", positions[0].currentPrice);
                }
                return originalDisplayPositions.apply(this, arguments);
            };
            console.log("displayPositionsWithCharts interceptor installed");
        } else {
            console.log("WARNING: displayPositionsWithCharts not found");
        }
        
        console.log("=== DEBUG SCRIPT READY ===");
    });
})();
</script>
</body>
</html>
